name: Deploy

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test:
    uses: ./.github/workflows/lint.yml

  deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Trigger Ansible deploy
        run: |
          ENVIRONMENT="${{ github.ref_name == 'main' && 'production' || 'staging' }}"
          BRANCH="${{ github.ref_name }}"

          echo "::notice::Triggering deploy-tentacle to $ENVIRONMENT (branch: $BRANCH)"

          HTTP_STATUS=$(curl -s -o /tmp/response.json -w "%{http_code}" -X POST \
            -H "Authorization: token ${{ secrets.GH_DISPATCH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/peanuts3942/octopus-ansible/dispatches \
            -d "{
              \"event_type\": \"deploy-tentacle\",
              \"client_payload\": {
                \"environment\": \"$ENVIRONMENT\",
                \"branch\": \"$BRANCH\"
              }
            }")

          if [ "$HTTP_STATUS" = "204" ]; then
            echo "::notice::Deploy triggered successfully. Check octopus-ansible Actions for progress."
          else
            echo "::error::Failed to trigger deploy (HTTP $HTTP_STATUS)"
            cat /tmp/response.json
            exit 1
          fi
