services:
  nginx:
    image: nginx:alpine
    container_name: tentacle_nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
    depends_on:
      - backend
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/sites-available/:/etc/nginx/sites-enabled/:ro
      - ./public:/var/www/html/public
      - ./storage/app/public:/var/www/html/public/storage:ro
    networks:
      - tentacle_frontend

  backend: &backend
    build:
      context: .
      dockerfile: Dockerfile
    image: tentacle-backend:latest
    container_name: tentacle_backend
    restart: unless-stopped
    environment:
      COMMAND: php artisan octane:start --host=0.0.0.0 --port=8000
      PROCESS: backend
    env_file:
      - .env
    volumes:
      - ./storage:/var/www/html/storage
      - ./public/build:/var/www/html/public/build:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tentacle_frontend
      - tentacle_backend

  horizon:
    <<: *backend
    container_name: tentacle_horizon
    environment:
      COMMAND: php artisan horizon
      PROCESS: horizon
    depends_on:
      - backend
      - redis
    networks:
      - tentacle_frontend
      - tentacle_backend

  scheduler:
    <<: *backend
    container_name: tentacle_scheduler
    environment:
      COMMAND: php artisan schedule:work
      PROCESS: scheduler
    depends_on:
      - backend
    networks:
      - tentacle_backend

  redis:
    image: redis:7-alpine
    container_name: tentacle_redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-secret}
      --appendonly yes
      --maxmemory ${REDIS_MAXMEMORY:-256}mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-secret}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - tentacle_backend

  meilisearch:
    image: getmeili/meilisearch:v1.13
    container_name: tentacle_meilisearch
    restart: unless-stopped
    environment:
      MEILI_MASTER_KEY: ${MEILISEARCH_KEY:-masterKey}
      MEILI_NO_ANALYTICS: true
      MEILI_ENV: ${MEILISEARCH_ENV:-production}
    volumes:
      - meilisearch_data:/meili_data
    networks:
      - tentacle_backend

  mariadb_test:
    image: mariadb:11.7
    container_name: tentacle_mariadb_test
    restart: unless-stopped
    environment:
      MARIADB_DATABASE: btbf_octopus_testing
      MARIADB_USER: testing
      MARIADB_PASSWORD: testing
      MARIADB_ROOT_PASSWORD: testing
    ports:
      - "${MARIADB_TEST_PORT:-3307}:3306"
    volumes:
      - mariadb_test_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tentacle_backend

networks:
  tentacle_frontend:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1400
  tentacle_backend:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1400

volumes:
  redis_data:
  meilisearch_data:
  mariadb_test_data:
